{% extends "base.html" %}
{% block title %} 2024 總統大選虛擬投票 {% endblock %}
{% block content%}
{% load static %}

<a href="https://line.me/R/ti/p/%40{{ line_bot_id }}" target="_blank">
  <img class="mx-auto d-block" style="max-width: 180px;" src="https://qr-official.line.me/gs/M_{{ line_bot_id }}_BW.png?oat_content=qr">
</a>

<!-- chart of vates -->
<div class="container-xl chart-container shadow p-3 mb-5 bg-body rounded">
  <canvas id="chart_vote"></canvas>
</div>

<!-- chart of option1 -->
<div class="container-xl chart-container shadow p-3 mb-5 bg-body rounded">
  <canvas id="chart_option1"></canvas>
</div>

<!-- chart of option2 -->
<div class="container-xl chart-container shadow p-3 mb-5 bg-body rounded">
  <canvas id="chart_option2"></canvas>
</div>

<!-- chart of option3 -->
<div class="container-xl chart-container shadow p-3 mb-5 bg-body rounded">
  <canvas id="chart_option3"></canvas>
</div>

<!-- chart of vote sum -->
<div class="container-xl chart-container shadow p-3 mb-5 bg-body rounded">
  <canvas id="chart_sum"></canvas>
</div>

<!-- candidate cards -->
<div class="container-fluid">
  <div class="row">
    {% for candidate in candidate_list %}
    <div class="col-lg-3 col-sm-6 px-xl-2 px-sm-1 my-3">
      <div class="card">
        <a href="{{ candidate.facebook }}" target="_blank">
          <img src="{% static '' %}/{{ candidate.name }}.jpg" class="card-img-top" style="border-radius: 50%">
        </a>
        <div class="card-body">
          <div class="row">
            <div class="col-9"><span class="fs-3 fw-bolder"> {{ candidate.name }} </span><span> {{ candidate.party }}
              </span></div>
            <img class="col-3" style="object-fit: contain;" src="{% static '無黨籍.png' %}">
            
          </div>
          <hr>
          <p>{{ candidate.profile }}</p>
        </div>
        <ul class="list-group list-group-flush">
          {% for comment in candidate.comments %}
          <li class="list-group-item">{{ comment.0 }}: {{ comment.1 }}</li>
          {% endfor %}
          <!-- <li class="list-group-item">更多 ...</li> -->
        </ul>
      </div>
    </div>
    {% endfor %}
  </div>
</div>


<script>
  const title = '2024 總統大選虛擬投票'
  const name_set = ['賴清德', '侯友宜', '柯文哲', '郭台銘', '尚未決定']
  const option_set = ['賴/侯/柯', '賴/侯/柯/郭', '最不希望當選']
  const color_set = [
    ['rgba(0, 154, 0, 0.8)', 'rgba(0, 0, 170, 0.8)', 'rgba(40, 200, 200, 0.8)', 'rgba(127, 127, 127, 0.8)', 'rgba(154, 59, 59, 0.8)'],
    ['rgba(0, 154, 0, 0.5)', 'rgba(0, 0, 170, 0.5)', 'rgba(40, 200, 200, 0.5)', 'rgba(127, 127, 127, 0.5)', 'rgba(154, 59, 59, 0.5)'],
    ['rgba(0, 154, 0, 0.2)', 'rgba(0, 0, 170, 0.2)', 'rgba(40, 200, 200, 0.2)', 'rgba(127, 127, 127, 0.2)', 'rgba(154, 59, 59, 0.2)']
  ]
  const datetime = new Date()
  const vote_set = {{ vote_list }}
  const record_list = {{ history_list| safe }}
  const vote_sum = []
  const date_set = []
  const record_set = Array(3).fill().map(() => Array(5).fill().map(() => Array(record_list.length)));
  // loop date
  for (let i = 0; i < record_list.length; i++) {
    vote_sum[i] = 0
    date_set.push(record_list[i]['date'].substring(5, 10))
    // loop candidate
    for (let j = 0; j < record_list[i]['vote'].length; j++) {
      vote_sum[i] += record_list[i]['vote'][j][1]
      // loop options
      for (let k = 0; k < record_list[i]['vote'][j].length; k++) {
        record_set[k][j][i] = record_list[i]['vote'][j][k]
      }
    }
  }

  // vote bar chart options
  let options = {
    scales: {
      y: {
        grace: '5%',
        beginAtZero: true,
        ticks: { font: { size: 16, weight: 'bold' } }
      },
      x: {
        ticks: { font: { size: 24, weight: 'bold' } }
      }
    },
    plugins: {
      title: {
        display: true,
        text: title,
        font: { size: 40 },
        padding: { top: 10, bottom: 10 }
      },
      subtitle: {
        display: true,
        align: 'end',
        text: '{% now "Y.m.d  H:i:s" %}',
        color: '#9A3B3B',
        font: { size: 20, weight: 'bold' },
      },
      legend: {
        labels: { font: { size: 20, weight: 'bold' } }
      },
      datalabels: {
        color: '#666',
        font: { size: 24, weight: 'bold' },
        anchor: 'end',
        align: 'end'
      }
    }
  }

  let datasets = []
  for (let i = 0; i < vote_set.length; i++) {
    datasets.push({
      label: option_set[i],
      data: vote_set[i],
      backgroundColor: color_set[i],
      borderWidth: 1,
    })
  }

  let ctx = document.getElementById('chart_vote');
  new Chart(ctx, {
    plugins: [ChartDataLabels],
    type: 'bar',
    data: {
      labels: name_set,
      datasets: datasets
    },
    options: options
  });

  // option-n line chart
  for (let i = 0; i < record_set.length; i++) {
    let options = {
      scales: {
        y: {
          grace: '5%',
          beginAtZero: true,
          ticks: { font: { size: 16, weight: 'bold' } }
        },
        x: {
          ticks: { font: { size: 16, weight: 'bold' } }
        }
      },
      plugins: {
        title: {
          display: true,
          text: option_set[i],
          color: '#9A3B3B',
          font: { size: 32 },
          padding: { top: 20, bottom: 10 }
        },
        legend: {
          labels: { font: { size: 20, weight: 'bold' } }
        },
        datalabels: {
          color: '#666',
          font: { size: 18, weight: 'bold' },
          align: 'end'
        }
      }
    }

    let datasets = []
    for (let j = 0; j < record_set[i].length; j++) {
      datasets.push({
        label: name_set[j],
        data: record_set[i][j],
        borderColor: color_set[0][j],
        borderWidth: 3
      })
    }
    if (i == 0) { datasets[3].hidden = true }

    let ctx = document.getElementById('chart_option' + (i + 1));
    new Chart(ctx, {
      plugins: [ChartDataLabels],
      type: 'line',
      data: {
        labels: date_set,
        datasets: datasets
      },
      options: options
    });

  }

  let ctx_sum = document.getElementById('chart_sum');
  new Chart(ctx_sum, {
    plugins: [ChartDataLabels],
    type: 'line',
    data: {
      labels: date_set,
      datasets: [{
        data: vote_sum,
        borderColor: '#AAA',
        borderWidth: 3
      }]
    },
    options: {
      aspectRatio: 3,
      scales: {
        y: {
          grace: '5%',
          ticks: { font: { size: 16, weight: 'bold' } }
        },
        x: {
          ticks: { font: { size: 16, weight: 'bold' } }
        }
      },
      plugins: {
        title: {
          display: true,
          text: "投票人數",
          color: '#9A3B3B',
          font: { size: 32 },
        },
        legend: {
          display: false
        },
        datalabels: {
          color: '#666',
          font: { size: 16, weight: 'bold' },
          align: 'end'
        }
      }
    }
  });

</script>

{% endblock %}